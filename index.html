<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub Live - Survival Game</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
        
        /* লোডিং স্ক্রিন */
        #loading-screen {
            position: absolute; width: 100%; height: 100%;
            background: #111; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
        }
        #progress-bar-container { width: 60%; height: 8px; background: #333; border-radius: 4px; margin-top: 20px; }
        #progress-bar { width: 0%; height: 100%; background: #00ff00; border-radius: 4px; }
        #status { color: #00ff00; margin-top: 10px; font-size: 14px; }

        /* গেম কন্ট্রোলস */
        #game-ui { display: none; }
        #joystick {
            position: absolute; bottom: 50px; left: 50px;
            width: 120px; height: 120px; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%;
        }
        #knob {
            position: absolute; top: 40px; left: 40px;
            width: 40px; height: 40px; background: #fff; border-radius: 50%;
        }
        #jump-btn {
            position: absolute; bottom: 60px; right: 50px;
            width: 80px; height: 80px; background: rgba(0,0,0,0.5);
            color: white; border: 2px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div id="status">LOADING MODEL: 0%</div>
        <div id="progress-bar-container"><div id="progress-bar"></div></div>
    </div>

    <div id="game-ui">
        <div id="joystick"><div id="knob"></div></div>
        <div id="jump-btn">JUMP</div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "./three.module.js",
            "three/addons/": "./"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/GLTFLoader.js';

        let scene, camera, renderer, player, mixer, clock = new THREE.Clock();
        let moveF = 0, turnS = 0, velY = 0, isGrounded = true;
        let idleAction, walkAction, activeAction;

        const statusText = document.getElementById('status');
        const pBar = document.getElementById('progress-bar');

        init();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 10, 80);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 1));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            // ম্যাপ তৈরি
            createMap();

            // মডেল লোড (সরাসরি Soldier.glb)
            const loader = new GLTFLoader();
            loader.load('Soldier.glb', 
                (gltf) => {
                    player = gltf.scene;
                    player.scale.set(1.5, 1.5, 1.5);
                    scene.add(player);

                    mixer = new THREE.AnimationMixer(player);
                    idleAction = mixer.clipAction(gltf.animations[0]);
                    walkAction = mixer.clipAction(gltf.animations[3]);
                    idleAction.play();
                    activeAction = idleAction;

                    // গেম শুরু
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('game-ui').style.display = 'block';
                    setupControls();
                    animate();
                },
                (xhr) => {
                    const percent = Math.round((xhr.loaded / xhr.total) * 100);
                    if (!isNaN(percent)) {
                        statusText.innerText = "LOADING MODEL: " + percent + "%";
                        pBar.style.width = percent + "%";
                    }
                },
                (err) => {
                    statusText.innerText = "Error: Soldier.glb not found!";
                    statusText.style.color = "red";
                }
            );
        }

        function createMap() {
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: 0x5a5a4a });
            const ground = new THREE.InstancedMesh(geo, mat, 1000);
            const matrix = new THREE.Matrix4();
            for (let i = 0; i < 1000; i++) {
                matrix.setPosition((i%30)-15, Math.floor(Math.sin(i*0.2)*1.2), Math.floor(i/30)-15);
                ground.setMatrixAt(i, matrix);
            }
            scene.add(ground);
        }

        function setupControls() {
            const knob = document.getElementById('knob');
            const joy = document.getElementById('joystick');
            
            const handleMove = (e) => {
                e.preventDefault();
                const t = e.touches[0];
                const r = joy.getBoundingClientRect();
                const dx = t.clientX - (r.left + r.width/2);
                const dy = t.clientY - (r.top + r.height/2);
                const d = Math.min(Math.sqrt(dx*dx + dy*dy), 45);
                const a = Math.atan2(dy, dx);

                knob.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                moveF = -Math.sin(a) * (d / 45);
                turnS = Math.cos(a) * (d / 45);

                if (activeAction !== walkAction) {
                    activeAction.fadeOut(0.2);
                    walkAction.reset().fadeIn(0.2).play();
                    activeAction = walkAction;
                }
            };

            joy.addEventListener('touchmove', handleMove, { passive: false });
            joy.addEventListener('touchend', () => {
                knob.style.transform = `translate(0,0)`;
                moveF = 0; turnS = 0;
                activeAction.fadeOut(0.2);
                idleAction.reset().fadeIn(0.2).play();
                activeAction = idleAction;
            });

            document.getElementById('jump-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (isGrounded) { velY = 0.22; isGrounded = false; }
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            if (mixer) mixer.update(dt);
            if (player) {
                if (Math.abs(moveF) > 0.1 || Math.abs(turnS) > 0.1) {
                    player.rotation.y -= turnS * 0.08;
                    player.translateZ(moveF * 0.2);
                }
                player.position.y += velY;
                if (player.position.y > 1.5) velY -= 0.01;
                else { player.position.y = 1.5; velY = 0; isGrounded = true; }

                const offset = new THREE.Vector3(0, 3, -8).applyMatrix4(player.matrixWorld);
                camera.position.lerp(offset, 0.1);
                camera.lookAt(player.position.x, player.position.y + 1.5, player.position.z);
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
